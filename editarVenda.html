<div class="">
	<div class="x_panel">
    	<div class="x_title">
			<h2>Informações do Pedido</h2>    		
		<div class="clearfix"></div>
		</div>
	
		<div class="x_content">
			<form id ="forminfo" class="collapse in">		
				<div class="row">													
					<div class="form-group">										
						<div class="col-md-1">		
							<label class="control-label col-md-8">N° Pedido</label>							
							<input type="text" id="Npedido" readonly="true" class="form-control col-md-2"/>
						</div>
						<div class="col-md-5"></div>													
						<div class="col-md-2">		
							<label class="control-label col-md-8">Data Venda</label>							
							<input type="text" id="dataVenda" class="form-control col-md-2"/>
						</div>
					</div>
				</div>	
				<div class="row">
					<div class="form-group">										
						<div class="col-md-4">		
							<label class="control-label col-md-2">Empresa</label>							
							<input type="text" readonly="true" id="empresa" class="form-control col-md-4"/>
						</div>
						<div class="col-md-2"></div>																
						<div class="col-md-3">		
							<label class="control-label col-md-1">Cidade</label>							
							<input type="text" readonly="true" id="cidade" class="form-control col-md-4"/>
						</div>		
					</div>						
				</div>	
				<div class="col-md-2"></div>
				<div class="col-md-2"></div>
				<div class="col-md-2"></div>					
			</form>	
		</div>	  
	</div>	  			
	<div class="x_panel">
		<div class="x_title">
			<h2>Adicionar Produto à Venda</h2>    
			<div class="clearfix"></div>
		</div>
			<div class="x_content">
				<div class="row">
					<div class="form-group">										
						<div class="col-md-4">		
							<label class="control-label col-md-2" >Nome</label>													
							<input id="NProduto" type="text" class="form-control col-md-2 " />
						</div>
						<div class="col-md-1">
							<input id="idProduto" type="hidden" class="form-control col-md-2 " />
						</div>
						<div class="col-md-1">
							<input id="cx" type="hidden" class="form-control col-md-2 " />
						</div>
						<div class="col-md-1">
							<input id="nomeProduto" type="hidden" class="form-control col-md-2 " />
						</div>
						<div class="col-md-1">		
							<label class="control-label col-md-4" >Preço</label>							
							<input type="text" id="preco"  required="required" class="form-control col-md-2"/>
						</div>
						<div class="col-md-1"></div>
						<div class="col-md-1">		
							<label class="control-label col-md-4" >Qtd</label>							
							<input type="text" id="qtd"  required="required" class="form-control col-md-2"/>
						</div>									
						<div class="col-md-1">		
							<label class="control-label col-md-4" >Uni.</label>																	
							<select id="unidades" class="form-control col-md-7 col-xs-12">                    
							</select>
						</div>	
						<div class="col-md-1"></div>
						<div class="col-md-1">
							<label class="control-label col-md-4" >&nbsp;</label>
							<button id="addrow" class="btn btn-primary" type="button">Adicionar</button>		
						</div>
					</div>													
				</div>
			</div>			 
	</div>
	<div class="x_panel">
		<div class="x_title">
			<h2>Pedido</h2>		       
			<div class="clearfix"></div>
		</div>
		<div class="x_content">
			<table id="tabela_pedido" class="table table-striped table-bordered noBorder">
				<thead>
					<tr>
					<th >cod</th>
					<th >Produto&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</th>
					<th>Preço Venda&nbsp;&nbsp;&nbsp;</th>
					<th>Qtd</th>
					<th>Uni.</th>
					<th>Valor</th>
					<th>alo</th>
					<th>&nbsp;&nbsp;&nbsp;</th>
					</tr>
				</thead>
					<tbody>		        		            						
					</tbody>
				</table>
				<div>
					<div class="x_content">
					</div class="x_title">
					<label id="totalVenda" style="font-size: 18px; color: rgb(250, 65, 65);" class="control-label col-md-4">Total: </label>		       
					<div class="clearfix"></div>
					</div>
				</div>
		</div>
		<div class="col-md-5"></div>
		<div >
			<button type="button" id="btnVender" class="btn btn-danger btn-lg">Finalizar Venda</button>
			
		</div>
	</div>
	
</div> 

<script>
$(function(){
    var idItemVenda, valorTotal=0, idEmpresa, idVenda, idUsuario;
	idVenda = $('#listaVendas').val();

	$( "#dataVenda" ).datepicker({
		dateFormat: 'dd/mm/yy',
		dayNames: ['Domingo','Segunda','Terça','Quarta','Quinta','Sexta','Sábado','Domingo'],
		dayNamesMin: ['D','S','T','Q','Q','S','S','D'],
		dayNamesShort: ['Dom','Seg','Ter','Qua','Qui','Sex','Sáb','Dom'],
		monthNames: ['Janeiro','Fevereiro','Março','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'],
		monthNamesShort: ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez']
	});

    $.ajax({
        type: 'get',
        dataType: 'json',
        url: 'http://localhost/ApiSC/public/unidades',
        success: function(data){				
            for(i=0; i<data.length; i++){  				
            $('#unidades').append('<option value="'+data[i].id+'" qtdUnidade="'+data[i].qtd+'">'+data[i].unidade+'</option>');
            }
        }
	});


    $('#NProduto').autocomplete({
        source: function(request, response){
            $.ajax({
                type: 'get',
                dataType: 'json',
                url: 'http://localhost/ApiSC/public/nomeproduto/'+ request.term +'',
                data: {
                    name: request.term                    
                },
                success: function(data){
                    response($.map(data, function(item){					
                        return {
                            label: item.nome,
                            value: item.nome,
                            id: item.id,
                            cx: item.cx							
                        }
                    }));
                }
            });
        },
        select: function(event, ui){
        // 	event.preventDefault();
            $('#idProduto').val(ui.item.id);
            $('#nomeProduto').text(ui.item.label);
            $('#cx').val(ui.item.cx);				
        },
        minLength: 0,
        autoFocus: true
    
    });

	// var t = $('#tabela_pedido').DataTable({
	// 	"ajax": {
    //  	"method": "GET",
    //  	"url": "http://localhost/ApiSC/public/itensvenda/"+idVenda,
	// 	//dataType: 'json',
	// 	//mDataProp: "",
	// 	//"dataType": "application/json; charset=utf-8",
    //    "dataSrc": "",
    // 	},
	// 	"aoColumns": [
	// 		{ "mData" : "PRODUTO_id"},
	// 		{ "mData" : "PRODUTO_id"},
	// 		{ "mData" : "valor"},
	// 		{ "mData" : "qtd"},
	// 		{ "mData" : "UNIDADE_id"},
	// 		{ "mData" : "btnDelete"},
    // 	],
		
		
	// 	// "ajax": {
	// 	// 	"method": "GET",
	// 	// 	"url": "http://localhost/ApiSC/public/itensvenda/"+idVenda,
	// 	// 	//"dataType": "application/json; charset=utf-8",
	// 	// 	"dataSrc": "",
	// 	// 	"sAjaxDataProp": "",
	// 	// },
	// 	// "columns": [
	// 	// 	{"data": "id"},
	// 	// 	{"data": "id"},
	// 	// 	{"data": "valor"},
	// 	// 	{"data": "qtd"},
	// 	// 	{"data": "UNIDADE_id"},
	// 	// ],

    //     "language": {
    //         "lengthMenu": "Mostrando _MENU_ registros por página",
    //         "zeroRecords": "Nada encontrado",
    //         "info": "Mostrando página _PAGE_ de _PAGES_",
    //         "infoEmpty": " ",
    //         "infoFiltered": "(filtrado de _MAX_ total records)",
    //         "search": "Pesquisar:",
    //         "paginate": {
    //           "first":      "Primeiro",
    //           "last":       "Ultimo",
    //           "next":       "Próximo",
    //           "previous":   "Anterior"
    //         }
    //     },
	// 	"columnDefs": [ 
	// 		// {
	// 		// "targets": [ 6 ],
    //         // "visible": false,
	// 		// },
	// 		// {
	// 		// "targets": 5,				
	// 		// "createdCell": function (td, cellData, rowData, row, col) {
	// 		// 		$(td).css('padding', '5px 0 0 20px')
	// 		// }
	// 		// },
	// 		{
	// 		"defaultContent": "-",
	// 		"targets": "_all"
	// 		}
	// 		],
	// 	order: [[0, "desc"]]
			
				
	// 	});

    var t = $('#tabela_pedido').DataTable({
		"ajax": {
     	"method": "GET",
     	"url": "http://localhost/ApiSC/public/itensvenda/"+idVenda,
		"dataSrc": function (json) {
				var return_data = new Array();
				var vparcial = 0, sprecoItem = 0, pVenda = 0;
				for(var i=0;i< json.length; i++){
					vparcial += parseFloat(json[i].ITEMVENDA_valor);	
					var x = parseFloat(json[i].ITEMVENDA_valor);
					var y = parseFloat(json[i].ITEMVENDA_pVenda);
					sprecoItem = x.toLocaleString('pt-br',{style: 'currency', currency: 'BRL'});
					pVenda = y.toLocaleString('pt-br',{style: 'currency', currency: 'BRL'});	

					t.row.add( [
						'<td id="data1">'+ json[i].ITEMVENDA_PRODUTO_id +'<td/>',
						'<td id="data2">'+ json[i].PRODUTO_nome +'<td/>',
						'<td id="data3">'+ pVenda +'<td/>',
						'<td id="data4">'+ json[i].ITEMVENDA_qtd +'<td/>',
						'<td id="data5">'+ json[i].UNIDADE_unidade +'<td/>',
						'<td id="data5">'+ sprecoItem +'<td/>',
						'<td>'+ json[i].ITEMVENDA_id  +'<td/>',
						'<button type="button" name="delete" id="'+ json[i].ITEMVENDA_id +'" class="btn btn-danger btn-xs">delete</button>',
					] ).draw();			
				}
				var pValor;
				valorTotal += vparcial; 
				pValor = valorTotal.toLocaleString('pt-br',{style: 'currency', currency: 'BRL'});
				$('#totalVenda').text('Total: '+ pValor);
			
      	}
    	},
		
        buttons: [
            {
            extend: 'print',						
            text: 'Imprimir',
            key: {
            key: 'p',
            altkey: true
            },    
            exportOptions: {  // ESCOLHER COLUNAS PARA SEREM IMPRIMIDAS
            columns: [ 0, 1, 2, 3, 4,5 ]
            }
            },
        ],
		dom: 'Blfrtip',
		//dom: 'Blfltip,
		// "ajax": {
		// 	"method": "GET",
		// 	"url": "http://localhost/ApiSC/public/itensvenda/"+idVenda,
		// 	//"dataType": "application/json; charset=utf-8",
		// 	"dataSrc": "",
		// 	"sAjaxDataProp": "",
		// },
		// "columns": [
		// 	{"data": "id"},
		// 	{"data": "id"},
		// 	{"data": "valor"},
		// 	{"data": "qtd"},
		// 	{"data": "UNIDADE_id"},
		// ],

        "language": {
            "lengthMenu": "Mostrando _MENU_ registros por página",
            "zeroRecords": "Nada encontrado",
            "info": "Mostrando página _PAGE_ de _PAGES_",
            "infoEmpty": " ",
            "infoFiltered": "(filtrado de _MAX_ total records)",
            "search": "Pesquisar:",
            "paginate": {
              "first":      "Primeiro",
              "last":       "Ultimo",
              "next":       "Próximo",
              "previous":   "Anterior"
            }
        },
		"columnDefs": [ 
			{
			"targets": [ 6 ],
            "visible": false,
			},
			{
			"targets": 7,				
			"createdCell": function (td, cellData, rowData, row, col) {
					$(td).css('padding', '5px 0 0 16px')
			}
			},
			// {
			// "defaultContent": "-",
			// "targets": "_all"
			// }
			],
		order: [[6, "desc"]]
			
				
		});
	//t.buttons().container().appendTo( $('.col-sm-6:eq(0)', t.table().container() ) );

    $('#addrow').on( 'click', function () {
		var nPedido = $('#Npedido').val();
		var qtd = $('#qtd').val();
		var preco = $('#preco').val();
		var idProduto = $('#idProduto').val();
		var qtdCx = $('#cx').val();
		var unidade = $('option:selected','#unidades').val();
		var unidadeTxt = $('option:selected','#unidades').text();
		var nomeProduto = $('#nomeProduto').text();
		//var btn = '<button type="button" class="btn btn-danger btn-xs " style="width: 100%; height: 100%;" >delete</button>';
		var qtdUnidade = $('option:selected', '#unidades').attr("qtdUnidade");

		preco = preco.replace(",", ".");
		var p = parseFloat(preco);
		var precoItem = 0;

		unidade == 1 ? precoItem = p * parseInt(qtdCx) * qtd : precoItem = p * parseInt(qtdUnidade) * qtd;	

		if(nomeProduto && idProduto && preco && qtd){       
			$.ajax({
				url: 'http://localhost/ApiSC/public/itemvenda',
				type: 'post',
				data: {
					qtd: qtd,
					valor: precoItem,
					pVenda: p,
					VENDA_id: nPedido,
					PRODUTO_id: idProduto,
					UNIDADE_id: unidade
				},
				success: function( data, textStatus, jQxhr ){
					var pValor;
					var k = JSON.parse(data);
					idItemVenda = k[0].id;
					var valorParcial = parseFloat(preco) * parseInt(qtd);

					unidade == 1 ? valorParcial *= parseInt(qtdCx) : valorParcial *= parseInt(qtdUnidade); // CX ou outras unidades
										
					valorTotal += valorParcial;
					valorTotal = valorTotal.toFixed(2);
					valorTotal = parseFloat(valorTotal);
					
					pValor = valorTotal.toLocaleString('pt-br',{style: 'currency', currency: 'BRL'});
					$('#totalVenda').text('Total: '+ pValor);

					var sprecoItem = precoItem.toLocaleString('pt-br',{style: 'currency', currency: 'BRL'});
					var pVenda = p.toLocaleString('pt-br',{style: 'currency', currency: 'BRL'});
					
					t.row.add( [
						'<td id="data1">'+ idProduto +'<td/>',
						'<td id="data2">'+ nomeProduto +'<td/>',
						'<td id="data3">'+ pVenda +'<td/>',
						'<td id="data4">'+ qtd +'<td/>',
						'<td id="data5">'+ unidadeTxt +'<td/>',
						'<td>'+ sprecoItem +'<td/>',						
						'<td>'+ idItemVenda +'<td/>',
						'<button type="button" name="delete" id="'+ idItemVenda +'" class="btn btn-danger btn-xs">delete</button>'
					] ).draw();			
				},
				error: function( jqXhr, textStatus, errorThrown ){
					console.log( errorThrown );
						alert('Produto inválido!');
				}
			});

            $('#NProduto').val('');
            $('#NProduto').focus();
            $('#qtd').val('');
            $('#preco').val('');
		}else{
			alert('Os campos precisam ser corretamente preenchidos!');
			$('#Nproduto').focus();     
		}
    });

    
	$('#tabela_pedido').on( 'click', "tr button[name='delete']", function (){
		var id = $(this).attr("id");
		var tr = $(this).closest("tr");
		var row = tr[0]._DT_RowIndex;
		//var id = $('#delete').attr("value");
		//var id = t.row( this ).index();
		//console.log(tr[0]._DT_RowIndex);
		if(confirm('Deseja retirar este item?')){
			$.ajax({
				type: 'delete',
				dataType: 'json',
				url: 'http://localhost/ApiSC/public/itemvenda/'+ id +'',
				success: function(data){
					var valorItem = parseFloat(data[0].valor);
					var pValor;
					valorTotal -= valorItem;
					pValor = valorTotal.toLocaleString('pt-br',{style: 'currency', currency: 'BRL'});
					$('#totalVenda').text('Total: '+ pValor);
				}
			});
			t.row( row ).remove().draw( false ); // deletar linha da datatable
		}
	});

		
	$('#btnVender').on('click', function(){
		if(!t.data().count()){
			alert("Nenhum produto inserido na venda");
		}else{
			var idVenda = $('#Npedido').val();
			var data = $('#dataVenda').val();
			var dataP = data.split("/");			
			var dataBanco = dataP[2]+'-'+dataP[1]+'-'+dataP[0];
			$.ajax({
					url: 'http://localhost/ApiSC/public/venda/'+ idVenda,
					type: 'post',
					dataType: 'json',
					data: {
						valor: valorTotal,
						date: dataBanco,
					},
					success: function(data){
						alert('Venda Finalizada');
						window.location.replace("index.html"); // CARREGA A PAGINA INICIAL
					},
			});
		}
	});

});

</script>