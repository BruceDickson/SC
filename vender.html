<div class="">
	<div class="x_panel">
    	<div class="x_title">
			<h2>Informações do Pedido</h2>    		
		<div class="clearfix"></div>
		</div>
	
		<div class="x_content">
			<form id ="forminfo" class="collapse in">		
				<div class="row">													
					<div class="form-group">										
						<div class="col-md-1">		
							<label class="control-label col-md-8">N° Pedido</label>							
							<input type="text" id="Npedido" readonly="true" class="form-control col-md-2"/>
						</div>
						<div class="col-md-5"></div>													
						<div class="col-md-2">		
							<label class="control-label col-md-8">Data Venda</label>							
							<input type="text" id="dataVenda" class="form-control col-md-2"/>
						</div>
					</div>
				</div>	
				<div class="row">
					<div class="form-group">										
						<div class="col-md-4">		
							<label class="control-label col-md-2">Empresa</label>							
							<input type="text" readonly="true" id="empresa" class="form-control col-md-4"/>
						</div>
						<div class="col-md-2"></div>																
						<div class="col-md-2">		
							<label class="control-label col-md-1">Cidade</label>							
							<input type="text" readonly="true" id="cidade" class="form-control col-md-4"/>
						</div>		
					</div>						
				</div>	
				<div class="col-md-2"></div>
				<div class="col-md-2"></div>
				<div class="col-md-2"></div>					
			</form>	
		</div>	  
	</div>	  			
	<div class="x_panel">
		<div class="x_title">
			<h2>Adicionar Produto à Venda</h2>    
			<div class="clearfix"></div>
		</div>
			<div class="x_content">
				<div class="row">
					<div class="form-group">										
						<div class="col-md-4">		
							<label class="control-label col-md-2" >Nome</label>													
							<input id="NProduto" type="text" class="form-control col-md-2 " />
						</div>
						<div class="col-md-1">
							<input id="idProduto" type="hidden" class="form-control col-md-2 " />
						</div>
						<div class="col-md-1">
							<input id="cx" type="hidden" class="form-control col-md-2 " />
						</div>
						<div class="col-md-1">
							<input id="nomeProduto" type="hidden" class="form-control col-md-2 " />
						</div>
						<div class="col-md-1">		
							<label class="control-label col-md-4" >Preço</label>							
							<input type="text" id="preco"  required="required" class="form-control col-md-2"/>
						</div>
						<div class="col-md-1"></div>
						<div class="col-md-1">		
							<label class="control-label col-md-4" >Qtd</label>							
							<input type="text" id="qtd"  required="required" class="form-control col-md-2"/>
						</div>									
						<div class="col-md-1">		
							<label class="control-label col-md-4" >Uni.</label>																	
							<select id="unidades" class="form-control col-md-7 col-xs-12">                    
							</select>
						</div>	
						<div class="col-md-1"></div>
						<div class="col-md-1">
							<label class="control-label col-md-4" >&nbsp;</label>
							<button id="addrow" class="btn btn-primary" type="button">Adicionar</button>		
						</div>
					</div>													
				</div>
			</div>			 
	</div>
	<div class="x_panel">
		<div class="x_title">
			<h2>Pedido</h2>		       
			<div class="clearfix"></div>
		</div>
		<div class="x_content">
			<table id="tabela_pedido" class="table table-striped table-bordered noBorder">
				<thead>
					<tr>
					<th >cod</th>
					<th >Produto&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</th>
					<th>Preço Venda&nbsp;&nbsp;&nbsp;</th>
					<th>Qtd</th>
					<th>Uni.</th>
					<th>&nbsp;&nbsp;&nbsp;</th>
					<th>alo</th>
					</tr>
				</thead>
					<tbody>		        		            						
					</tbody>
				</table>
				<div>
					<div class="x_content">
					</div class="x_title">
					<label id="totalVenda" style="font-size: 18px; color: rgb(250, 65, 65);" class="control-label col-md-4">Total: </label>		       
					<div class="clearfix"></div>
					</div>
				</div>
		</div>
		<div class="col-md-5"></div>
		<div >
			<button type="button" id="btnVender" class="btn btn-danger btn-lg">Finalizar Venda</button>
		</div>
	</div>
	
</div> 

<script>
	//$('#NProduto').editableSelect();
	var idItemVenda, valorTotal=0, idEmpresa, idUsuario;

	$( "#dataVenda" ).datepicker({
			dateFormat: 'dd/mm/yy',
			dayNames: ['Domingo','Segunda','Terça','Quarta','Quinta','Sexta','Sábado','Domingo'],
			dayNamesMin: ['D','S','T','Q','Q','S','S','D'],
			dayNamesShort: ['Dom','Seg','Ter','Qua','Qui','Sex','Sáb','Dom'],
			monthNames: ['Janeiro','Fevereiro','Março','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'],
			monthNamesShort: ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez']
	});

	function getFormattedDate(date) {
	  var year = date.getFullYear();

	  var month = (1 + date.getMonth()).toString();
	  month = month.length > 1 ? month : '0' + month;

	  var day = date.getDate().toString();
	  day = day.length > 1 ? day : '0' + day;
	  
	  return day + '/' + month + '/' + year;
	}

	// function removeAcento (text){       
  //   text = text.toLowerCase();                                                         
  //   text = text.replace(new RegExp('[ÁÀÂÃ]','gi'), 'a');
  //   text = text.replace(new RegExp('[ÉÈÊ]','gi'), 'e');
  //   text = text.replace(new RegExp('[ÍÌÎ]','gi'), 'i');
  //   text = text.replace(new RegExp('[ÓÒÔÕ]','gi'), 'o');
  //   text = text.replace(new RegExp('[ÚÙÛ]','gi'), 'u');
  //   text = text.replace(new RegExp('[Ç]','gi'), 'c');
  //   return text;                 
	// }

	$(function(){
	  var date = new Date();
	  $('#dataVenda').val(getFormattedDate(date));

	  // $.ajax({
	  //   type:'get',   
	  //   dataType: 'json', 
	  //   url: 'http://localhost/ApiSC/public/empresas',
	  //   success: function(data){
	  //     for(i=0; i<data.length; i++){       
	  //       $('#empresa').append('<option value="'+data[i].EMPRESA_id+'">'+data[i].EMPRESA_nome+'</option>');
	  //     }
		// 		idEmpresa = data[i].EMPRESA_id;
	  //   }
	  // });

		$.ajax({
			type: 'get',
			dataType: 'json',
			url: 'http://localhost/ApiSC/public/lastvenda',
			success: function(data){
				document.getElementById('Npedido').value = (data[0].id - 1);
			}
		});

		$.ajax({
			type: 'get',
			dataType: 'json',
			url: 'http://localhost/ApiSC/public/unidades',
			success: function(data){				
				for(i=0; i<data.length; i++){  				
	        	$('#unidades').append('<option value="'+data[i].id+'" qtdUnidade="'+data[i].qtd+'">'+data[i].unidade+'</option>');
	      }
			}
		});

		$('#NProduto').autocomplete({
			source: function(request, response){
				$.ajax({
					type: 'get',
					dataType: 'json',
					url: 'http://localhost/ApiSC/public/nomeproduto/'+ request.term +'',
					data: {
						name: request.term                    
					},
					success: function(data){
					  response($.map(data, function(item){					
							return {
								label: item.nome,
								value: item.nome,
								id: item.id,
								cx: item.cx							
							}
						}));
					}
				});
			},
			select: function(event, ui){
			// 	event.preventDefault();
				$('#idProduto').val(ui.item.id);
				$('#nomeProduto').text(ui.item.label);
				$('#cx').val(ui.item.cx);				
			},
			minLength: 0,
			autoFocus: true
		
		});

		var t = $('#tabela_pedido').DataTable({
			  // dom: 'Bfrtip',
				//ordering: false,
			//	"bSort": false,
			//	"aaSorting": [],
			 //"bSortable": false, "aTargets": [ 0 ] ,
        buttons: [
				{
						extend: 'print',						
            text: 'Imprimir',
            key: {
                key: 'p',
                altkey: true
						},
						
						exportOptions: {  // ESCOLHER COLUNAS PARA SEREM IMPRIMIDAS
              columns: [ 0, 1, 2, 3, 4 ]
						}
				},
        ],
        "language": {
            "lengthMenu": "Mostrando _MENU_ registros por página",
            "zeroRecords": "Nada encontrado",
            "info": "Mostrando página _PAGE_ de _PAGES_",
            "infoEmpty": " ",
            "infoFiltered": "(filtrado de _MAX_ total records)",
            "search": "Pesquisar:",
            "paginate": {
              "first":      "Primeiro",
              "last":       "Ultimo",
              "next":       "Próximo",
              "previous":   "Anterior"
            }
        },
		"columnDefs": [ 
			{
			"targets": [ 6 ],
            "visible": false,
			},
			{
			"targets": 5,				
			"createdCell": function (td, cellData, rowData, row, col) {
					$(td).css('padding', '5px 0 0 20px')
			}
			} ],
			order: [[6, "desc"]]
			
				
		});
	t.buttons().container().appendTo( $('.col-sm-6:eq(0)', t.table().container() ) );
 
    $('#addrow').on( 'click', function () {
		var nPedido = $('#Npedido').val();
		var qtd = $('#qtd').val();
		var preco = $('#preco').val();
		var idProduto = $('#idProduto').val();
		var qtdCx = $('#cx').val();
		var unidade = $('option:selected','#unidades').val();
		var unidadeTxt = $('option:selected','#unidades').text();
		var nomeProduto = $('#nomeProduto').text();
		var btn = '<button type="button" class="btn btn-danger btn-xs " style="width: 100%; height: 100%;" >delete</button>';
		var qtdUnidade = $('option:selected', '#unidades').attr("qtdUnidade");

		preco = preco.replace(",", ".");

		if(nomeProduto && idProduto && preco && qtd){       
			$.ajax({
				url: 'http://localhost/ApiSC/public/itemvenda',
				type: 'post',
				data: {
					qtd: qtd,
					valor: 0,
					VENDA_id: nPedido,
					PRODUTO_id: idProduto,
					UNIDADE_id: unidade
				},
				success: function( data, textStatus, jQxhr ){
					var pValor;
					var k = JSON.parse(data);
					idItemVenda = k[0].id;
					var valorParcial = parseFloat(preco) * parseInt(qtd);

					unidade == 1 ? valorParcial *= parseInt(qtdCx) : valorParcial *= parseInt(qtdUnidade); // CX ou outras unidades
										
					valorTotal += valorParcial;
					valorTotal = valorTotal.toFixed(2);
					valorTotal = parseFloat(valorTotal);
					
					pValor = valorTotal.toLocaleString('pt-br',{style: 'currency', currency: 'BRL'});
					$('#totalVenda').text('Total: '+ pValor);
					
					t.row.add( [
						'<td id="data1">'+ idProduto +'<td/>',
						'<td id="data2">'+ nomeProduto +'<td/>',
						'<td id="data3">'+ preco +'<td/>',
						'<td id="data4">'+ qtd +'<td/>',
						'<td id="data5">'+ unidadeTxt +'<td/>',
						'<button type="button" name="delete" id="'+ idItemVenda +'" class="btn btn-danger btn-xs">delete</button>',
						'<td>'+ idItemVenda +'<td/>'
					] ).draw();			
				},
				error: function( jqXhr, textStatus, errorThrown ){
					console.log( errorThrown );
						alert('Produto inválido!');
				}
			});

		$('#NProduto').val('');
		$('#NProduto').focus();
		$('#qtd').val('');
		$('#preco').val('');
		}else{
			alert('Os campos precisam ser corretamente preenchidos!');
			$('#Nproduto').focus();     
		}
    });

	$('#tabela_pedido').on( 'click', "tr button[name='delete']", function (){
		var id = $(this).attr("id");
		var tr = $(this).closest("tr");
		var row = tr[0]._DT_RowIndex;
		//var id = $('#delete').attr("value");
		//var id = t.row( this ).index();
		//console.log(tr[0]._DT_RowIndex);
		if(confirm('Deseja retirar este item?')){
			$.ajax({
				type: 'delete',
				dataType: 'json',
				url: 'http://localhost/ApiSC/public/itemvenda/'+ id +'',
				success: function(){
					//console.log('removido');
				}
			});
			t.row( row ).remove().draw( false ); // deletar linha da datatable
		}
	});

	var data = $('#dataVenda').val();
    //Exploda a data para entrar no formato aceito pelo DB.
    var dataP = data.split("/");			
    var dataBanco = dataP[2]+'-'+dataP[1]+'-'+dataP[0];
		
	$('#btnVender').on('click', function(){
		if(!t.data().count()){
			alert("Nenhum produto inserido na venda");
		}else{
			var idVenda = $('#Npedido').val();
			$.ajax({
					url: 'http://localhost/ApiSC/public/venda/'+ idVenda,
					type: 'post',
					dataType: 'json',
					data: {
						valor: valorTotal,
						date: dataBanco,
					},
					success: function(data){
						alert('Venda Finalizada');
						window.location.replace("index.html"); // CARREGA A PAGINA INICIAL
					},
			});
		}
	});
		
  

	// $(window).bind('beforeunload', function(){
	// 	return '>>>>>Before You Go<<<<<<<< \n Your custom message go here';
	// });
		

	});
</script>